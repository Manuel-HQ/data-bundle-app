<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buy Data</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='buy.css') }}">
  <style>
    /* Minimal styles for the added modals/buttons */
    .modal-overlay { position: fixed; inset: 0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); z-index: 1000; }
    .modal-box { background:#111; color:#eee; padding:20px; border-radius:12px; width: min(520px, 92vw); box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
    .modal-details { background:#161616; padding:12px; border-radius:8px; margin:12px 0; font-size:14px; }
    .modal-actions { display:flex; gap:10px; justify-content:flex-end; }
    .modal-actions button { padding:8px 12px; border:none; border-radius:8px; cursor:pointer; }
    .btn-primary { background:#22c55e; color:#0a0a0a; }
    .btn-ghost { background:#1f1f1f; color:#ddd; }
    .alert-box { background:#2a0f0f; color:#ffd2d2; border:1px solid #531515; padding:12px; border-radius:8px; margin-bottom:10px; display:none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="form-card">
      <h2>Purchase Data Bundle</h2>

      <div id="insufficientAlert" class="alert-box"></div>

      <form id="purchaseForm" action="{{ url_for('purchase') }}" method="POST" onsubmit="event.preventDefault(); showConfirmation();">
        <label for="network">Network</label>
        <select name="network" id="network" required onchange="updateBundles()">
          <option value="" disabled selected>-- Choose Network --</option>
          <option value="MTN">MTN</option>
          <option value="Vodafone">Vodafone</option>
          <option value="AirtelTigo">AirtelTigo</option>
        </select>

        <label for="bundle">Data Bundle</label>
        <select name="bundle" id="bundle" required>
          <option value="" disabled selected>-- Select Bundle --</option>
        </select>

        <label for="mobile">Recipient Mobile Number</label>
        <input type="text" name="mobile" id="mobile" placeholder="e.g. 0551234567" required>

        <input type="hidden" name="price" id="price">
        <input type="submit" value="Buy Now" class="btn">
      </form>

      <a href="{{ url_for('dashboard') }}" class="back-link">‚Üê Back to Dashboard</a>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div id="confirmationModal" class="modal-overlay">
    <div class="modal-box">
      <h3>Confirm Purchase</h3>
      <div id="confirmationDetails" class="modal-details"></div>
      <div class="modal-actions">
        <button type="button" class="btn-primary" onclick="submitPurchase()">Confirm</button>
        <button type="button" class="btn-ghost" onclick="closeModal('confirmationModal')">Cancel</button>
      </div>
    </div>
  </div>

  

  <script>
    const bundleOptions = {
       MTN: [
            "1 GB - 5.40 GHS", "2 GB - 10.50 GHS", "3 GB - 14.50 GHS", "4 GB - 19.50 GHS",
            "5 GB - 24.70 GHS", "6 GB - 29.70 GHS", "8 GB - 37.00 GHS", "10 GB - 47.50 GHS",
            "15 GB - 68.50 GHS", "20 GB - 88.00 GHS", "25 GB - 113.00 GHS", "30 GB - 131.00 GHS",
            "40 GB - 168.00 GHS", "50 GB - 197.00 GHS"
        ],
        Vodafone: [
            "1 GB - 4.90 GHS", "2 GB - 9.50 GHS", "3 GB - 13.00 GHS", "4 GB - 17.50 GHS",
            "5 GB - 22.00 GHS", "6 GB - 26.00 GHS", "8 GB - 34.00 GHS", "10 GB - 44.00 GHS",
            "15 GB - 64.00 GHS", "20 GB - 84.00 GHS", "25 GB - 108.00 GHS", "30 GB - 126.00 GHS",
            "40 GB - 160.00 GHS", "50 GB - 190.00 GHS"
        ],
        AirtelTigo: [
            "1 GB - 5.00 GHS", "2 GB - 10.00 GHS", "3 GB - 14.00 GHS", "4 GB - 19.00 GHS",
            "5 GB - 24.00 GHS", "6 GB - 28.00 GHS", "8 GB - 36.00 GHS", "10 GB - 46.00 GHS",
            "15 GB - 67.00 GHS", "20 GB - 86.00 GHS", "25 GB - 110.00 GHS", "30 GB - 128.00 GHS",
            "40 GB - 165.00 GHS", "50 GB - 194.00 GHS"
        ]
    };

    const WALLET_BALANCE = Number('{{ balance | default(0.0) }}');

    function updateBundles() {
      const network = document.getElementById('network').value;
      const bundleSelect = document.getElementById('bundle');
      bundleSelect.innerHTML = '<option value="" disabled selected>-- Select Bundle --</option>';
      if (bundleOptions[network]) {
        bundleOptions[network].forEach(bundle => {
          const option = document.createElement('option');
          option.value = bundle;
          option.textContent = bundle;
          bundleSelect.appendChild(option);
        });
      }
    }

    function parsePriceGHS(bundleStr) {
      const match = bundleStr.match(/-\s*([\d.]+)\s*GHS/i);
      return match ? parseFloat(match[1]) : 0;
    }

    function showConfirmation() {
      const network = document.getElementById('network').value;
      const bundle = document.getElementById('bundle').value;
      const mobile = document.getElementById('mobile').value;

      if (!network || !bundle || !mobile) {
        alert("Please fill out all fields before continuing.");
        return;
      }

      const price = parsePriceGHS(bundle);
      document.getElementById('price').value = price;

      // Client-side guard for insufficient funds -> show popup
      if (price > WALLET_BALANCE) {
        document.getElementById('insufficientDetails').innerHTML = `
          You are trying to buy <strong>${bundle}</strong> for <strong>${price.toFixed(2)} GHS</strong> but your
          current wallet balance is <strong>${WALLET_BALANCE.toFixed(2)} GHS</strong>.
        `;
        openModal('insufficientModal');
        return;
      }

      const details = `
        <strong>Network:</strong> ${network}<br>
        <strong>Bundle:</strong> ${bundle}<br>
        <strong>Recipient:</strong> ${mobile}<br>
        <strong>Price:</strong> ${price.toFixed(2)} GHS
      `;
      document.getElementById('confirmationDetails').innerHTML = details;
      openModal('confirmationModal');
    }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function submitPurchase() {
      const form = document.getElementById('purchaseForm');
      const fd = new FormData(form);

      fetch("{{ url_for('purchase') }}", {
        method: 'POST',
        body: fd,
        headers: { 'X-Requested-With': 'fetch' }
      })
      .then(async (res) => {
        if (!res.ok) {
          const data = await res.json().catch(() => ({ error: 'Purchase failed' }));
          closeModal('confirmationModal');
          const alert = document.getElementById('insufficientAlert');
          alert.textContent = data.error || 'Purchase failed';
          alert.style.display = 'block';
          if (data.balance !== undefined) {
            document.getElementById('insufficientDetails').innerHTML = `Your balance is <strong>${Number(data.balance).toFixed(2)} GHS</strong>.`;
            openModal('insufficientModal');
          }
          return;
        }
        // Success
        window.location.href = "{{ url_for('dashboard') }}";
      })
      .catch(() => {
        closeModal('confirmationModal');
        alert('Network error. Please try again.');
      });
    }
  </script>
</body>
</html>